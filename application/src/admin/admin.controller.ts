import {
  Controller,
  Get,
  Render,
  Res,
  Post,
  Body,
  Req,
  RawBodyRequest,
  UseGuards,
  UploadedFiles,
  UseInterceptors,
  Param,
  Query,
} from '@nestjs/common';
import { AdminService } from './admin.service';
import { ApiConsumes, ApiParam, ApiQuery, ApiTags } from '@nestjs/swagger';
import { AuthGuard } from '@nestjs/passport';
import { FileFieldsInterceptor, FileInterceptor } from '@nestjs/platform-express';

@Controller('admin')
@ApiTags('admin')
@UseGuards(AuthGuard('jwt'))
export class AdminController {
  constructor(private readonly adminService: AdminService,
    // private eventsGateway:EventsGateway
    ) {}

  @Get('/configuration')
  async renderConfig(@Res() Res,){
    const config_data = await this.adminService.readConfig()
    const interfaces= await this.adminService.get_interfaces()
    Res.render('admin/config.hbs', {
      config_data: config_data,
      interfaces: interfaces
    });
  }
  @Get('/detect')
  async renderDetect(@Res() Res){
    let data=await this.adminService.readConfig()
    let event_data=await this.adminService.getAllEventData()
    let state=1  
    if (event_data===""){
      state=0 //not running
    }
    Res.render('admin/detect.hbs', {
      interfaces: data.interfaces,
      event_data: event_data,
      state:state
    });
  }

  @Post('/update_config')
  async updateConfig(@Req() req: RawBodyRequest<Request>){
    await this.adminService.updateConfig(req.body)
    return true
  }

  @Post('/start_detect')
  async start_detect(@Req() req){
    this.adminService.detect()
    return true
  }

  @Post('/stop_detect')
  async stop_detect(){
    await this.adminService.stop_detect()
    // await this.eventsGateway.closeSlipsSocket()
  }

  @Get('/noti')
  async getNoti(){
    return this.adminService.getNoti();
  }

  @Get('/train')
  async renderTraining(@Res() Res){
    await this.adminService.getDataTrain()
    Res.render('admin/train.hbs', {
    });
  }

  @UseInterceptors(
    FileFieldsInterceptor([{ name: 'pcap'}], {
      dest: '/tmp/pcap_malware',
    }),
  )
  @Post('/trainModel')
  @ApiConsumes('multipart/form-data')
  async trainingModel(@Res() Res, @Req() req,@Body() data,@UploadedFiles() file:Express.Multer.File){
    this.adminService.trainModel(data, file)
    return true
  }

  @Post('/stop_train')
  async stop_train(){
    await this.adminService.stop_train()
    // await this.eventsGateway.closeSlipsSocket()
  }

  @Get('/statistics')
  async report(@Res() Res){
    Res.render('admin/statistics.hbs', {
    });
  }

  @Get('/statistics/date')
  @ApiQuery({
    name: 'type',
    required: true,
    type: String,
  })
  async getDate(@Query('type') type?: string,){
    const data=await this.adminService.getDateReport(type)
    return data
  }

  @Get('/statistics/data')
  @ApiQuery({
    name: 'type',
    required: true,
    type: String,
  })
  @ApiQuery({
    name: 'date',
    required: true,
    type: String,
  })
  @ApiQuery({
    name: 'label',
    required: true,
    type: String,
  })
  async getData(@Query('type') type?: string,@Query('date') date?: string,@Query('label') label?: string){
    let all_data=await this.adminService.getDataReport(type,date, label)
    const bound_data=await this.adminService.getByteInFile(all_data)
    // all_data.forEach((item,index)=>{
    //   delete all_data[index]['directory']
    // })
    console.log(111, all_data)
    return {all_data, bound_data}
  }
  
  
}
