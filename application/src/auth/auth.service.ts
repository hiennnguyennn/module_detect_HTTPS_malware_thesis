import { Injectable, HttpException, HttpStatus, BadGatewayException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import * as bcrypt from 'bcrypt';
import { JwtService } from '@nestjs/jwt';
import {UserDto} from './dto/user.dto'
import {User} from '../admin/entity/user.entity'
import { ConfigService } from '@nestjs/config';

@Injectable()
export class AuthService {
    constructor(@InjectRepository(User) private userRepository: Repository<User>,
    private jwtService: JwtService, private configService:ConfigService) { }

    //handle register for controller
    async register(user:UserDto){
        if(await this.findUserByUsername(user.username)){
            throw new BadGatewayException('EMAIL EXIST')
        }
        else{
            const saltOrRounds=this.configService.get('saltOrRounds')
            user.password = await bcrypt.hash(user.password, saltOrRounds);
            const u=await this.userRepository.save(user)
            const payload={
                id: u.id,
                username: u.username,
                salt: this.configService.get('salt')
            }
            const jwt = await this.jwtService.sign(payload);
            return jwt;
        }
    }
    async findUserByUsername(username: string) {
        const u=await this.userRepository.findOneBy({ username })
        return u
    }

    //handle login for controller
    async login(u) {
        const payload = {
          id: u.id,
          username: u.username,
          salt: this.configService.get('salt'),
        };
        const jwt = await this.jwtService.sign(payload);
        return jwt;
    }
    async validateUser(username, password) {
        const u = await this.findUserByUsername(username);
        if (u && (await bcrypt.compare(password, u.password))) {
          delete u.password;
          return u;
        }
        return null;
    }
    async findUser(username: string, id: number) {
        const u = this.userRepository
          .createQueryBuilder('user')
          .where('user.id= :id', { id: id })
          .andWhere('user.username= :username', { username: username })
          .select('user.username')
          .addSelect('user.id')
          .getOne();
        return u;
    }

    async getAllUser(){
        return this.userRepository.createQueryBuilder('user')
        .select('user.username')
        .addSelect('user.mail')
        .getMany()
    }
     
}