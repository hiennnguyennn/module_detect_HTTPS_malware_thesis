import os
import json

#all folder pcap already have ips file save list source address malware and normal
space = '\t'

def write_conn_log(path, flow_array):
  print("Writing label to conn_label.log: "+ path)
  index=0
  with open(os.path.join(path,'conn_label.log'),'w') as f:
    for i in range(len(flow_array)):
      f.write(json.dumps(flow_array[i])+'\r\n')
      index+=1
  f.close()
  print("     << Number of lines:", index)
  print("<< New file conn_label.log was succesfly created.")

def take_label_from_binet_flow(path_folder_input, path_folder_output):
  flow_array=check_conn_label(path_folder_input, path_folder_output)
  write_conn_log(path_folder_output, flow_array)
  
def check_conn_label(path_folder_input, path_folder_output):
  print("---------------------Check connection log------------------------")
  infected_ips_list=[]
  normal_ips_list=[]
  flow_array=[]
  ips_file=os.path.join(path_folder_input,'ips.log')
  malware_label=0
  normal_label=0
  with open(ips_file) as f:
    for line in f:
      split=line.split(space)
      if 'malware' in split[1]:
        infected_ips_list.append(split[0])
      elif 'normal' in split[1]:
        normal_ips_list.append(split[0])
  with open(os.path.join(path_folder_output,"conn.log")) as f:
    for line in f:
      newline=json.loads(line)
      try:
        src_address=newline['id.orig_h']
      except:
        print("Done load connection file")
      if src_address in infected_ips_list:
        newline['label']='malware'
      elif src_address in normal_ips_list:
        newline['label']='normal'
      else:
        continue
      flow_array.append(newline)
    f.close()
  print('Done loadding conn.log')
  # malware_label='#malware label: '+str(malware_label)+'\n'
  # normal_label='#normal label: '+str(normal_label)+'\n'
  # flow_array.insert(0, malware_label)
  # flow_array.insert(1, normal_label)
  return flow_array


