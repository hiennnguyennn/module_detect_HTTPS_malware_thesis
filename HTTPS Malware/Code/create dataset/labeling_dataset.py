import os
import glob
from pathlib import Path
import socket
import ipaddress
#all folder pcap already have ips file save list source address malware and normal
space = '\t'
def write_conn_log(path, flow_array):
  print("Writing label to conn.log: "+ path)
  index=0
  with open(path+"/bro/conn_label1.log",'w') as f:
    for i in range(len(flow_array)):
      f.write(flow_array[i])
      index+=1
  f.close()
  print("     << Number of lines:", index)
  print("<< New file conn_label1.log was succesfly created.")
def take_label_from_binet_flow(path):
  flow_array=check_conn_label(path)
  write_conn_log(path, flow_array)

def check_conn_label(path_to_dataset):
  print("---------------------Check connection log------------------------")
  infected_ips_list=[]
  normal_ips_list=[]
  flow_array=[]
  ips_file=path_to_dataset+'/ips.log'
  malware_label=0
  normal_label=0
  with open(ips_file) as f:
    for line in f:
      split=line.split(space)
      if 'malware' in split[1]:
        infected_ips_list.append(split[0])
      elif 'normal' in split[1]:
        normal_ips_list.append(split[0])
  with open(path_to_dataset+"/bro/conn.log") as f:
    for line in f:
      newline=line
      if '#'==line[0]:
        if 'fields' in line:
          newline = line.strip() + space + "label" + "\n"
        elif 'types' in line:
          newline = line.strip() + space + "string" + "\n"
        else:
          continue
        flow_array.append(newline)
      else:
        error=0     
        split=line.split('	')
        try:
          src_address=split[2]
        except:
          print("Done load connection file")
        error=0
        if src_address in infected_ips_list:
          newline=line.strip() + space + "botnet" + "\n"
          error+=1
          malware_label+=1
        elif src_address in normal_ips_list:
          newline=line.strip() + space + "normal" + "\n"
          error+=1
          normal_label+=1
        if error==0:
          continue
        if error>1:
          print("Error: SrcAddress has more classes. Program is terminated.")
          break
        flow_array.append(newline)
    f.close()
  print('Done loadding conn.log')
  malware_label='#malware label: '+str(malware_label)+'\n'
  normal_label='#normal label: '+str(normal_label)+'\n'
  flow_array.insert(0, malware_label)
  flow_array.insert(1, normal_label)
  return flow_array

# def main():
#   folder=Path(__file__).parents[1]
#   folder = folder / 'download_datasets'
#   sub_folders = [name for name in os.listdir(folder) if os.path.isdir(os.path.join(folder, name))]
#   for index in range(len(sub_folders)):
#     # if 69<index:
#       sub_folder_name=sub_folders[index]
#       folder=str(folder)
#       take_label_from_binet_flow(str(folder)+'/'+str(sub_folder_name))

def main(folder,sub_folders):
  for index in range(len(sub_folders)):
    sub_folder_name=sub_folders[index]
    folder=str(folder)
    take_label_from_binet_flow(str(folder)+'/'+str(sub_folder_name))
main('/home/hiennnn/Documents/DATN/normal_traffic',['traffic 7','traffic 8', 'traffic 9', 'traffic 10'])
